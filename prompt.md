# 早押し音声識別実験ソフトウェア仕様書（v1.1）

## 0. 目的と背景
本実験は、100カテゴリの音声（以下「音」）に対して、参加者が **「識別できた」と判断した瞬間にボタン押下して音声再生を停止し、その後100択で回答** する“早押し”型タスクを通じて、各音ごとの行動開始判断時間（go-time）と正答傾向、ならびに参加者の **リスク戦略（speed–accuracy tradeoff; SAT）** を数量化することを目的とする。

---

## 1. 実験条件
- 対象カテゴリ数：100音（ID: 1..100）
- 参加者：個人内で100音すべて実施（分担なし）
- セッション時間：2時間想定
- 試行時間目安：1試行あたり約10秒（目標値）
- 本課題試行数：100音 × 6試行 = 600試行（原則固定）
- 追加：motor校正タスク（30試行推奨：20〜40で設定可能）

### 1.1 テストモード
- 開発や動作確認のために、全体フローを短時間で実行するためのモード。
- **Motor校正**: 試行回数を3回に短縮。
- **本課題**:
  - 特定の少数カテゴリ（例: 5カテゴリ）のみを出題対象とする。
  - 各カテゴリの繰り返し回数を設定可能（例: 5回）。
  - 回答UIは本番と同様の100択形式を維持する。

---

## 2. 実験全体フロー
1) 参加者情報入力（メタデータ）  
2) 説明・練習（任意）  
3) **motor校正タスク（必須）**：30試行  
4) **本課題（必須）**：600試行（100音×6）  
5) 終了画面：簡易統計表示

---

## 3. 刺激（音声）仕様
- 各カテゴリ i に対応する **フル音声**ファイルが存在する（例：`001.wav`〜`100.wav`）
- 音声は **先頭から自動再生**し、参加者の押下で **即時停止**
- 押下後は **再生再開しない**
- 音量：推奨として事前正規化（RMS/LUFS）またはソフト側補正
- 再生遅延を最小にするため、可能なら事前ロード／バッファリングを行う
- **読手の切替**: 複数の読手セット（フォルダ単位）を切り替え可能とする。

### 3.1 読手ごとの実装仕様
システムは複数の読手をサポートし、読手ごとに異なるファイル命名規則を許容する。

- **難波津いなばくん (sounds_Inaba)**:
  - 命名規則: `I-[ID(3桁)][タイプ].ogg` (例: `I-001A.ogg`)
  - タイプ: `A` (上の句), `B` (下の句/合図音)
  - 合図音: `I-000B.ogg` を固定で使用。
- **木本 景子さん (sounds_kimoto)**:
  - 命名規則: `[決まり字] [句].m4a` (例: `あきの 上.m4a`)
  - 句: `上` (上の句), `下` (下の句)
  - 合図音: `序歌.m4a` を固定で使用。

読手追加時は、`kimariji.json` の決まり字データと各読手のファイル名を紐付けるマッピングロジックを `script.js` 内に実装する。

---

## 4. UI / UX 要件
本ソフトウェアのUIは、初学者でも直感的に理解し、スムーズに操作できることを目指します。

### 4.1 全体的なUI体験
- **完全日本語化**: ユーザーに表示されるすべてのテキストは日本語に統一されています。
- **スクロールの排除**: 各画面はビューポート内に収まるように設計されており、画面遷移によって情報が切り替わるため、スクロール操作は不要です。
- **画面遷移の明確化**: 実験フローの各段階が明確に区切られています。
- **コントラストの改善**: UI要素の視認性を高めています。

### 4.2 Trial画面（共通）
- 試行開始と同時に音声を自動再生
- 画面中央に大きな「押下ボタン」を表示
- 押下入力：キーボード / マウスクリック / ゲームパッド
- 押下時：
  1. 音声停止
  2. 直ちに回答画面へ遷移

### 4.3 回答画面（100択）
- 100カテゴリを段階的に選択できるUI。
- **入力方式（2ステップ）**:
  1. **頭文字選択**: 五十音表グリッド（縦レイアウト）で頭文字を選択する。
  2. **候補選択**: 選択した頭文字で始まる決まり字の候補が、クリック箇所に円形メニュー（SVGドーナツ型）として表示される。
- **円形メニューの仕様**:
  - 選択肢の並びはランダム（試行・参加者ごとに異なる）：押しやすさに差が出ないようにするため
  - leafセクターをクリック→緑にハイライト、中央ボタンが「決定」に変わる
  - 決定前はホバーで候補を展開できるが、選択済み（緑）の状態ではホバーで変化しない
  - 背景クリック or ESCキー→選択解除（緑を外す）
  - 中央ボタン「戻る」→メニューを閉じる
  - 選択→ちらつきなし（`applyPieSelection`/`applyPieDeselection` でSVGを再描画せず色だけ更新）
- **わからないボタン**: 五十音表の下に共通で配置。
  - 選択した場合：`is_unknown: 1` としてGASに保存した上で、試行をデッキの最後に追加（刺激情報のみコピー、タイミングデータは含めない）
  - 追加課題分は `total-trials` の表示も動的に更新される

### 4.4 休憩（推奨）
- 50試行ごとに休憩画面（スキップ可）

---

## 5. タイミング計測（高優先）
- 試行開始（課題音声再生スタート）を `t0` として記録
- 押下時刻 `t_press` を高精度タイムスタンプで記録（ms単位）
- 音声再生開始の実タイミングを `t0` にする

---

## 6. motor校正タスク（必須）
### 6.1 目的
内容認識が不要な反応課題（ビープ音）により、運動反応＋機器遅延の代表値を推定する。

### 6.2 刺激・手順
- 刺激：短いビープ音（例：440Hz, 100ms）
- 1試行：
  - ランダム待機（例：1.5–2.5秒）後にビープ提示
  - 次の試行に移る際、約0.5秒のディレイを設けて「回数が進んだ」ことをユーザーが認識できるようにする。
- 試行数：30（推奨）

---

## 7. 本課題仕様（必須）
### 7.1 1試行の手順
1. 刺激カテゴリ `stimulus_id = i` を決定
2. **合図音の再生**: 全試行共通の合図音の末尾2秒を再生する。
   - **重要**: 合図音自体が準備の役割を果たすため、回答完了後、可能な限り速やかに（ディレイを最小限にして）合図音の再生を開始する。
3. **無音待機**: 1秒間の無音時間を設ける。
4. **課題音声の再生開始**（この時点を `t0` として記録）  
5. 参加者が「識別できた」と判断した瞬間に押下（`t_press` 記録）  
6. 音声停止  
7. 100択回答（「わからない」の場合は後回し）
8. 次試行へ

---

## 8. 保存データ（ログ仕様）
データはGoogle Apps Script (GAS) を通じて随時スプレッドシートに保存される。ローカルへのCSVダウンロード機能は原則不要。

### 8.1 スプレッドシート連携（再開機能）
- 参加者ID入力時にGASへ問い合わせ、既存のランダムシードと完了済みの試行数を取得する。
- 未登録の参加者の場合は、クライアント側でシードを生成し、GASへ登録する。

### 8.2 保存されるデータ項目（本課題 `trial_single`）
- `participant_id`
- `session_timestamp`（セッション開始時刻、JST）
- `random_seed`
- `trial_index`（試行通し番号）
- `stimulus_id`
- `kimariji`（決まり字）
- `rep`（繰り返し番号）
- `trial_start_time`（課題音声再生開始時刻、JST）
- `press_time`（音声再生開始からボタン押下までのms）
- `t_prime`（press_time - t_motor、motor補正後RT）
- `choice_id`（選んだカードのID、わからない時は null）
- `is_correct`（1 or 0）
- `is_unknown`（わからないボタンを押した場合 1、通常は未設定）
- `t_answer`（ボタン押下から回答決定までのms）
- `is_test_mode`
- `t_motor`（motor校正の中央値ms）
- `userAgent`

### 8.3 GAS POSTタイプ一覧
| type | 用途 | シート |
|------|------|--------|
| `get_status` | 参加者の進捗・シード取得（レスポンス読み取りあり） | participants / trials / motor_trials |
| `register_seed` | 新規参加者のシード登録 | participants |
| `motor_trial` | motor校正1試行の保存 | motor_trials |
| `trial_single` | 本課題1試行の保存（わからない時も含む） | trials |
| `trials_batch` | 複数試行のまとめ保存（休憩・終了時バックアップ） | trials |
| `summary` | セッション全体の要約保存 | summaries |

---

## 9. 前処理（分析に必要な派生量）
### 9.1 motor補正（go-time）
- `t_prime = press_time - t_motor`

---

## 10. 分析アウトプット（参加者ごと）
- 速度指標 S
- 正確度指標 A
- リスク指標 Δ
- SAT 勾配 β

---

## 11. ソフトウェア機能要件まとめ
### 必須
- **セッション再開機能**: IDベースで中断したところから再開。
- **即時保存**: 試行ごとにGAS経由でスプレッドシートに保存。
- **迅速な試行開始**: 本課題では回答後すぐに合図音を流す。
- **共通「わからない」ボタン**: 五十音表UIに統合。
- **再試行ロジック**: わからない問題を最後に回す。
- **UI改善**: 円形メニューの描画バグ解消（1項目の際など）。

---

## 12. TODO・実装状況

### 完了済み ✅
- スプレッドシートとの接続（GAS経由）
- 読手の切替UI（sounds_kimoto / sounds_Inaba）、音声ファイルの読み込みも読手に合わせて切り替え
- ビープ音：開始ボタン後に即始まらない（準備時間＋ランダム待機）
- 実験環境の確定（PC＋イヤホン）
- 「わからない」ボタン（GASへの保存、後でやり直しロジック含む）
- 保存データ項目（participant_id, seed, trial_index, stimulus_id, press_time, t_prime, choice_id, is_correct, is_unknown, t_answer等）
- 試行ごとの即時保存（`trial_single` をGASへPOST、わからない時も保存）
- 途中復帰（IDでGASに問い合わせ→完了試行数取得）
- 回答途中の試行は未回答扱い（「わからない」でデッキ末尾へ、刺激情報のみコピー）
- 一字決まりの円形メニューUIバグ修正
- 円形メニュー選択時のちらつき防止（SVG再描画なし）
- 円形メニューの選択肢位置をランダム化（毎回異なる配置）
- 選択済み状態のホバー固定（ホバーで選択が消えない）
- trial-counter の総数を動的更新（わからない追加時に表示が追従）
- motor校正のクリックフィードバックを即時表示（CSSで transition:none、JSでフィードバックを先頭に）
- 木本さんの音声が流れるよう修正（`state.reader` に読手を保存、startMainPhaseで参照）

### 技術的な注意事項
- `get_status` は通常CORS fetch（レスポンス読み取り必要）
- `trial_single` / `motor_trial` / `register_seed` / `summary` は fire-and-forget（レスポンス不要）
- 参加者IDは小文字に正規化して扱う
- シードはGASから取得（新規参加者はクライアント生成→register_seed）
- HTMLのscreen IDはケバブケース（`screen-main-intro`等）、JSの screens配列も合わせること
- 読手（`state.reader`）は `startMotorPhase` で `reader-select` から取得し、`startMainPhase` で使用する
  - sounds_kimoto: 合図音=`sounds_kimoto/序歌.m4a`、課題音=`sounds_kimoto/${kimariji} 上.m4a`
  - sounds_Inaba: 合図音=`sounds_Inaba/I-000B.ogg`、課題音はmanifest.jsonから`A.ogg`で抽出
- 「わからない」追加時はタイミングデータを含めず刺激情報のみをコピーすること（再試行で上書きされるため）
- motor反応フィードバック：`classList.add("responded")` はhandlePress内で最初に実行し、CSSの `.responded` には `transition: none` を設定（即時反応のため）
- `applyPieSelection`/`applyPieDeselection` で選択色の更新はSVG再描画なしで実施（`data-card-id` 属性を利用）
- 選択中（`state.selectedChoice` が非null）はホバーイベント（`onmouseenter`）を無効化する
