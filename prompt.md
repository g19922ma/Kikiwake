# 早押し音声識別実験ソフトウェア仕様書（v1.0）

## 0. 目的と背景
本実験は、100カテゴリの音声（以下「音」）に対して、参加者が **「識別できた」と判断した瞬間にボタン押下して音声再生を停止し、その後100択で回答** する“早押し”型タスクを通じて、各音ごとの行動開始判断時間（go-time）と正答傾向、ならびに参加者の **リスク戦略（speed–accuracy tradeoff; SAT）** を数量化することを目的とする。

---

## 1. 実験条件
- 対象カテゴリ数：100音（ID: 1..100）
- 参加者：個人内で100音すべて実施（分担なし）
- セッション時間：2時間想定
- 試行時間目安：1試行あたり約10秒（目標値）
- 本課題試行数：100音 × 6試行 = 600試行（原則固定）
- 追加：motor校正タスク（30試行推奨：20〜40で設定可能）

### 1.1 テストモード
- 開発や動作確認のために、全体フローを短時間で実行するためのモード。
- **Motor校正**: 試行回数を3回に短縮。
- **本課題**:
  - 特定の少数カテゴリ（例: 5カテゴリ）のみを出題対象とする。
  - 各カテゴリの繰り返し回数を設定可能（例: 5回）。
  - 回答UIは本番と同様の100択形式を維持する。

---

## 2. 実験全体フロー
1) 参加者情報入力（メタデータ）  
2) 説明・練習（任意）  
3) **motor校正タスク（必須）**：30試行  
4) **本課題（必須）**：600試行（100音×6）  
5) 終了画面：保存確認・ログ出力・（可能なら簡易統計表示）

---

## 3. 刺激（音声）仕様
- 各カテゴリ i に対応する **フル音声**ファイルが存在する（例：`001.wav`〜`100.wav`）
- 音声は **先頭から自動再生**し、参加者の押下で **即時停止**
- 押下後は **再生再開しない**
- 音量：推奨として事前正規化（RMS/LUFS）またはソフト側補正
- 再生遅延を最小にするため、可能なら事前ロード／バッファリングを行う

---

## 4. UI / UX 要件
本ソフトウェアのUIは、初学者でも直感的に理解し、スムーズに操作できることを目指します。

### 4.1 全体的なUI体験
- **完全日本語化**: ユーザーに表示されるすべてのテキストは日本語に統一されています。
- **スクロールの排除**: 各画面はビューポート内に収まるように設計されており、画面遷移によって情報が切り替わるため、スクロール操作は不要です。
- **画面遷移の明確化**: 実験フローの各段階（参加者情報入力、運動反応計測、本課題説明、試行、回答、休憩、終了）が明確に区切られ、ユーザーが迷わないように配慮されています。
- **コントラストの改善**: UI要素（特にボタンのテキストと背景）は十分なコントラスト比を確保し、視認性を高めています。

### 4.2 Trial画面（共通）
- 試行開始と同時に音声を自動再生
- 画面中央に大きな「押下ボタン」を表示
- 押下入力：キーボード / マウスクリック / ゲームパッド
- 押下時：
  1. 音声停止
  2. 直ちに回答画面へ遷移

### 4.3 回答画面（100択）
- 100カテゴリを段階的に選択できるUI。
- **入力方式（2ステップ）**:
  1. **頭文字選択**: 五十音表グリッド（縦レイアウト）で頭文字を選択する。有効な頭文字（決まり字が存在するもの）は活性化され、そうでないものは非活性化される。非活性ボタンのコントラストも改善されている。
  2. **候補選択**: 選択した頭文字で始まる決まり字の候補が、**マウスクリックした位置に円形メニューとして表示**される。これにより、ユーザーは移動距離を最小限に抑えつつ直感的に候補を選択できる。選択後、「確定」ボタンを押す。
- 確定後、次試行へ。

### 4.4 休憩（推奨）
- 例：50試行ごとに休憩画面（スキップ可）
- 疲労によるSAT変化の過大化を抑える

---

## 5. タイミング計測（高優先）
- 試行開始（音声再生スタート）を `t0` として記録
- 押下時刻 `t_press` を **高精度タイムスタンプ**で記録（ms単位、可能ならms未満）
- 回答確定時刻 `t_answer` を記録（推奨）
- 可能なら、音声再生開始の実タイミング（オーディオAPIの再生開始コールバック等）に近い時刻を `t0` にする

---

## 6. motor校正タスク（必須）
### 6.1 目的
内容認識が不要な反応課題（ビープ音）により、運動反応＋機器遅延の代表値を推定し、本課題の押下時刻から差し引いて「行動開始判断時間（go-time）」を近似する。

### 6.2 刺激・手順
- 刺激：短いビープ音（例：50〜100ms）
- 1試行：
  - ランダム待機（例：0.8–1.6秒）後にビープ提示
  - 参加者は「聞こえたら即押下」
  - 反応時間を記録
- 試行数：30（推奨）

### 6.3 motor推定値
- 代表値：
  - `t_motor = median(rt_motor)` を採用
- ばらつき指標：
  - IQR（四分位範囲）も保存推奨

---

## 7. 本課題仕様（必須）
### 7.1 1試行の手順
1. 刺激カテゴリ `stimulus_id = i` を決定
2. **合図音の再生**: 全試行共通の合図音の末尾2秒を再生する。
3. **無音待機**: 1秒間の無音時間を設ける。
4. **課題音声の再生開始**（この時点を `t0` として記録）  
5. 参加者が「識別できた」と判断した瞬間に押下（`t_press` 記録）  
6. 音声停止（押下後の追加情報なし）  
7. 100択回答（`choice_id` 記録、`t_answer` 記録）  
8. 次試行へ

### 7.2 刺激提示の割当
- 各カテゴリ i を 6回提示（固定）
- 全600試行をランダム順に提示
- 推奨制約：
  - 同一カテゴリの連続提示を避ける
  - ブロック内でカテゴリ偏りを緩和（例：20試行内の重複抑制）

### 7.3 フィードバック
- 正誤フィードバックは **基本OFF推奨**（学習・戦略変化を抑える）
- ONにする場合は条件として固定し、ログに設定を残す

---

## 8. 保存データ（ログ仕様）
### 8.1 参加者メタデータ（1レコード）
- `participant_id`（匿名ID）
- `date_time_start`, `date_time_end`
- `device_info`（OS, audio device, input device）
- `experiment_version`（git hash等）
- `audio_set_version`（刺激セットの版）
- `block_settings`（休憩間隔等）
- `notes`（任意）

### 8.2 motor校正ログ（trial単位）
最低限：
- `participant_id`
- `phase = "motor"`
- `trial_index`
- `t0_timestamp`
- `t_press_timestamp`
- `rt_motor = t_press - t0`（ms）
- `input_device_type`（keyboard/mouse/gamepad）
- `trial_flags`（例：二重押下、未押下、エラー）

### 8.3 本課題ログ（trial単位：最重要）
最低限：
- `participant_id`
- `phase = "main"`
- `trial_index`
- `stimulus_id`（1..100）
- `stimulus_file`（パス or ハッシュ）
- `t0_timestamp`
- `t_press_timestamp`
- `press_time = t_press - t0`（ms）
- `choice_id`（1..100）
- `is_correct`（0/1）
- `t_answer_timestamp`（推奨）
- `answer_time = t_answer - t_press`（推奨）
- `block_index`
- `input_device_type`
- `trial_flags`（例：timeout、未押下、音声再生エラー）

---
**【変更点：ログ出力形式と内容】**
現在、ログはJSON形式ではなくCSV形式で出力されます。
各試行ログ（8.3項）には、参加者メタデータ（8.1項）に加え、**参加者ごとの概要統計指標（速度S, 正確度A, リスクΔ）も各行に付加**されます。
motor校正ログ（8.2項）は個別には出力されず、CSVには本課題ログのみが記録されます。
---

### 8.4 エラーハンドリング
- 音声再生失敗・入力欠落などは `trial_flags` に記録
- 分析時に除外可能な設計にする

---

## 9. 前処理（分析に必要な派生量）
### 9.1 motor補正（go-time）
motor校正で得た `t_motor` を用いて各試行のgo-timeを定義する：

- `t_prime = press_time - t_motor`

（記号：`t'`）

### 9.2 除外規則（推奨）
- `press_time` が極端（例：<50ms、>音声長）などは除外
- 未押下がある場合は `trial_flags` で明示（timeout等）
- `t'` が負になる場合：
  - 計測ノイズ／先押しの可能性あり
  - 方針：除外 or 0にクリップ（どちらかを仕様として固定しログにも残す）

---

## 10. 分析アウトプット（参加者ごと）
### 10.1 音（カテゴリ）ごとの指標（i = 1..100）
各音6試行（有効試行のみ）から算出：

- 行動開始判断時間：
  - `T_i = mean(t')`（デフォルト：戦略反映のため平均）
- 正答率：
  - `A_i = mean(is_correct)`
- 推奨追加（品質指標）：
  - `SD_i = sd(t')`
  - `n_i = 有効試行数`

### 10.2 参加者ごとの指標（主指標）
本課題全試行（有効試行）を用いる。

#### (1) Speed 指標 S
- `S = median(t')`
- 行動開始の典型速度（分布仮定不要）

#### (2) Accuracy 指標 A
- `A = mean(is_correct)`
- 全体正答率

#### (3) Risk 指標 Δ（賭け押し度）
- `Δ = mean(t' | incorrect) - mean(t' | correct)`
- 解釈：
  - Δ < 0：誤答がより早い（賭け押し傾向）
  - Δ ≈ 0：中立
  - Δ > 0：遅いのに外す（迷い／混同）

#### (4) SAT 勾配 β（待つ価値）
参加者全試行でロジスティック回帰：
- `P(correct) = sigmoid(α + β t')`
- 出力：`β` と（可能なら）標準誤差・信頼区間
- 解釈：
  - β 大：待つほど当たりやすい（待つ価値がある）
  - β 小：待っても当たりやすさが変わりにくい（得意/苦手の両方があり得るので α とセット解釈）

※注意：ここでのロジスティックは「識別時間推定」ではなく「戦略の勾配」抽出目的で用いる。

---

## 11. 指標の解釈（仕様上の明記）
- `T_i` は「識別時間」ではなく **行動開始判断時間（go-time）** の代表値
- motor補正は近似であり完全な分離ではない
- 主眼は **戦略（速さと正確さの取り方）** であり、`S, A, Δ, β` により数量化する
- 分布の正規性は仮定しない（中央値、条件付き平均、ロジスティック回帰で対応）

---

## 12. ソフトウェア機能要件まとめ
### 必須
- 100音刺激の管理（ロード・再生・停止）
- **試行開始時の合図音再生機能**
- 押下イベント取得（複数入力デバイス対応）
- 高精度タイムスタンプ記録
- **回答UIの変更**:
  - 頭文字選択は五十音表グリッド（縦レイアウト）
  - 候補選択はクリック箇所に表示される円形メニュー
- motor校正タスク実装
- **テストモード機能**
- ログ出力（CSV）＋バージョン情報記録、および概要統計の含め
- 休憩ブロック制御
- **試行間待機時間（「準備」画面）の撤廃**

### 推奨
- 練習ブロック（数試行）
- 音量調整・ヘッドホン確認
- 例外時の再試行（音声再生失敗など）
- セッション再開（途中保存）
- 終了後に簡易指標（S,A,Δ,β）を画面表示

---

## 13. 解析実装要件（別工程で実装可能）
- 入力：
  - `participant_meta`、`motor_trials`、`main_trials`
- 出力（推奨）：
  1) `participant_summary.json`（S,A,Δ,β, t_motor, 除外数等）
  2) `per_item_metrics.csv`（T_i, A_i, SD_i, n_i）
  3) 図（任意）：t'分布、正誤別分布、SAT曲線

---

## 付録：推奨ディレクトリ構成
/stimuli/
  001.wav ... 100.wav
  manifest.json （ID→ファイル、ラベル、補正値など）
/logs/
  participant_meta.json
  motor_trials.jsonl
  main_trials.jsonl
/analysis/
  scripts/
  outputs/
